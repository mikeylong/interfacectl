{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://schemas.surfaces.local/interfacectl.diff.schema.json",
  "title": "interfacectl diff output",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "tool", "contract", "observed", "normalization", "summary", "entries"],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "description": "Version of this output schema (breaking changes require bump).",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "tool": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "version"],
      "properties": {
        "name": { "type": "string", "const": "interfacectl" },
        "version": { "type": "string", "minLength": 1 }
      }
    },
    "policy": {
      "type": "object",
      "description": "Present when diff is produced under an enforcement policy context.",
      "additionalProperties": false,
      "required": ["version", "fingerprint"],
      "properties": {
        "version": { "type": "string", "minLength": 1 },
        "fingerprint": {
          "type": "string",
          "description": "Deterministic hash of policy content (implementation-defined, e.g., sha256).",
          "pattern": "^[a-f0-9]{32,128}$"
        }
      }
    },
    "contract": {
      "type": "object",
      "additionalProperties": false,
      "required": ["path", "version"],
      "properties": {
        "path": { "type": "string", "minLength": 1 },
        "version": { "type": "string", "minLength": 1 }
      }
    },
    "observed": {
      "type": "object",
      "additionalProperties": false,
      "required": ["root"],
      "properties": {
        "root": { "type": "string", "minLength": 1 },
        "captureProfile": {
          "type": "object",
          "description": "Optional metadata describing how observed artifacts were produced.",
          "additionalProperties": true
        }
      }
    },
    "normalization": {
      "type": "object",
      "additionalProperties": false,
      "required": ["enabled", "reorderedPaths", "strippedPaths"],
      "properties": {
        "enabled": { "type": "boolean" },
        "reorderedPaths": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Paths where ordering was normalized away (set-like)."
        },
        "strippedPaths": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Paths removed as ephemeral."
        }
      }
    },
    "summary": {
      "type": "object",
      "additionalProperties": false,
      "required": ["totalChanges", "byType", "bySeverity"],
      "properties": {
        "totalChanges": { "type": "integer", "minimum": 0 },
        "byType": {
          "type": "object",
          "additionalProperties": false,
          "required": ["added", "removed", "modified", "renamed"],
          "properties": {
            "added": { "type": "integer", "minimum": 0 },
            "removed": { "type": "integer", "minimum": 0 },
            "modified": { "type": "integer", "minimum": 0 },
            "renamed": { "type": "integer", "minimum": 0 }
          }
        },
        "bySeverity": {
          "type": "object",
          "additionalProperties": false,
          "required": ["error", "warning", "info"],
          "properties": {
            "error": { "type": "integer", "minimum": 0 },
            "warning": { "type": "integer", "minimum": 0 },
            "info": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "entries": {
      "type": "array",
      "description": "Deterministically ordered: surfaceId asc, then path asc, then type asc.",
      "items": { "$ref": "#/$defs/DiffEntry" }
    },
    "driftRisks": {
      "type": "array",
      "description": "Optional drift risk signals produced by drift-detection utilities.",
      "items": { "$ref": "#/$defs/DriftRisk" }
    },
    "repro": {
      "type": "object",
      "description": "Optional local reproduction hints for CI output.",
      "additionalProperties": false,
      "required": ["command"],
      "properties": {
        "command": { "type": "string", "minLength": 1 }
      }
    }
  },
  "$defs": {
    "Severity": {
      "type": "string",
      "enum": ["error", "warning", "info"]
    },
    "DiffChangeType": {
      "type": "string",
      "enum": ["added", "removed", "modified", "renamed"]
    },
    "DiffEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "path", "severity"],
      "properties": {
        "surfaceId": {
          "type": "string",
          "description": "Surface identifier when diffing multiple surfaces.",
          "minLength": 1
        },
        "type": { "$ref": "#/$defs/DiffChangeType" },
        "path": {
          "type": "string",
          "description": "Canonical JSON Pointer or canonical dot-path. Must be stable.",
          "minLength": 1
        },
        "contractValue": { "description": "Value from contract, if applicable." },
        "observedValue": { "description": "Value from observed artifact, if applicable." },
        "severity": { "$ref": "#/$defs/Severity" },
        "rule": {
          "type": "string",
          "description": "Rule or contract clause identifier that explains why this entry exists.",
          "minLength": 1
        },
        "autofixable": {
          "type": "boolean",
          "description": "True only when a policy rule allows safe/mechanical autofix."
        },
        "rename": {
          "type": "object",
          "description": "Only present when type=renamed.",
          "additionalProperties": false,
          "required": ["fromPath", "toPath", "confidence"],
          "properties": {
            "fromPath": { "type": "string", "minLength": 1 },
            "toPath": { "type": "string", "minLength": 1 },
            "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "renamed" } }, "required": ["type"] },
          "then": { "required": ["rename"] }
        }
      ]
    },
    "DriftRisk": {
      "type": "object",
      "additionalProperties": false,
      "required": ["category", "severity", "message"],
      "properties": {
        "category": {
          "type": "string",
          "enum": [
            "diff-noise",
            "semantic-ambiguity",
            "enforcement-overreach",
            "policy-drift",
            "contract-evolution",
            "observed-instability",
            "rename-inflation",
            "output-schema-drift",
            "severity-inflation",
            "local-ci-mismatch"
          ]
        },
        "severity": { "$ref": "#/$defs/Severity" },
        "message": { "type": "string", "minLength": 1 },
        "relatedPaths": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        }
      }
    }
  }
}
